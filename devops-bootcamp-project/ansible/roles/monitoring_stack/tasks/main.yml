---
- name: Ensure monitoring directory exists
  ansible.builtin.file:
    path: /opt/monitoring
    state: directory
    mode: "0755"

- name: Ensure grafana provisioning directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /opt/monitoring/grafana/provisioning/datasources
    - /opt/monitoring/grafana/provisioning/dashboards
    - /opt/monitoring/grafana/dashboards

- name: Copy Grafana datasource provisioning
  ansible.builtin.copy:
    src: grafana/provisioning/datasources/datasource.yml
    dest: /opt/monitoring/grafana/provisioning/datasources/datasource.yml
    mode: "0644"

- name: Copy Grafana dashboard provisioning
  ansible.builtin.copy:
    src: grafana/provisioning/dashboards/dashboard.yml
    dest: /opt/monitoring/grafana/provisioning/dashboards/dashboard.yml
    mode: "0644"

- name: Render Prometheus config
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: /opt/monitoring/prometheus.yml
    mode: "0644"

- name: Stop existing Prometheus container if present
  ansible.builtin.command:
    cmd: docker rm -f prometheus
  register: rm_prom
  failed_when: false
  changed_when: "rm_prom.rc == 0"

- name: Ensure monitoring docker network exists
  ansible.builtin.command:
    cmd: docker network create monitoring
  register: net_create
  failed_when: false
  changed_when: "net_create.rc == 0"

- name: Run Prometheus container
  ansible.builtin.command:
    cmd: >-
      docker run -d --name prometheus --restart unless-stopped
      -p 9090:9090
      -v /opt/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      --network monitoring
      prom/prometheus:latest
  register: prom_run
  changed_when: "prom_run.rc == 0"

- name: Stop existing Grafana container if present
  ansible.builtin.command:
    cmd: docker rm -f grafana
  register: rm_graf
  failed_when: false
  changed_when: "rm_graf.rc == 0"

- name: Run Grafana container
  ansible.builtin.command:
    cmd: >-
      docker run -d --name grafana --restart unless-stopped
      -p 3000:3000
      -v /opt/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      -v /opt/monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      --network monitoring
      grafana/grafana:latest
  register: graf_run
  changed_when: "graf_run.rc == 0"
